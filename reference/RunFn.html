<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Run the Punt et al. (2008) ADMB-based ageing error model from within R."><title>Run ageing error model — RunFn • AgeingError</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run ageing error model — RunFn"><meta property="og:description" content="Run the Punt et al. (2008) ADMB-based ageing error model from within R."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">AgeingError</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/getting_started.html">Estimating ageing error using the TMB model written by André Punt</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/pfmc-assessments/AgeingError/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Run ageing error model</h1>
      <small class="dont-index">Source: <a href="https://github.com/pfmc-assessments/AgeingError/blob/HEAD/R/RunFn.R" class="external-link"><code>R/RunFn.R</code></a></small>
      <div class="d-none name"><code>RunFn.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Run the Punt et al. (2008) ADMB-based ageing error model from within R.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">RunFn</span><span class="op">(</span></span>
<span>  <span class="va">Data</span>,</span>
<span>  <span class="va">SigOpt</span>,</span>
<span>  <span class="va">KnotAges</span>,</span>
<span>  <span class="va">BiasOpt</span>,</span>
<span>  NDataSets <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">MinAge</span>,</span>
<span>  <span class="va">MaxAge</span>,</span>
<span>  <span class="va">RefAge</span>,</span>
<span>  <span class="va">MinusAge</span>,</span>
<span>  <span class="va">PlusAge</span>,</span>
<span>  <span class="va">MaxSd</span>,</span>
<span>  <span class="va">MaxExpectedAge</span>,</span>
<span>  <span class="va">SaveFile</span>,</span>
<span>  EffSampleSize <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  Intern <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  AdmbFile <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  JustWrite <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  CallType <span class="op">=</span> <span class="st">"system"</span>,</span>
<span>  ExtraArgs <span class="op">=</span> <span class="st">" -est"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>Data</dt>
<dd><p>This is the data set with the first column being an integer
providing the number of otoliths that are included in the row and the
subsequent columns are the reader or lab estimated ag,e where each
reader/lab has a unique reading error and bias. The modeling framework
allows for, at most, 15 readers, i.e., 16 columns. There should not be any
identical rows in the data frame because otoliths that have the exact same
read from every reader/lab should be combined into a single row with the
count as the first column. If you failed to combine identical rows prior
to running the model, you will be alerted with an error and the <code>XXX.rep</code>
file will have a properly formatted data which can be' cut-pasted into a
<code>XXX.dat</code> file for use. Missing reads from a given reader/lab should be
entered as <code>-999</code>. Order your reader/lab columns such that similar
readers/labs are located next to one another because columns to the right
can mirror columns to their immediate left in terms of parameter
estimates.</p></dd>


<dt>SigOpt</dt>
<dd><p>This a vector with one entry for each reader (i.e.,
<code>length(SigOpt) == NCOL(Data) -1</code>). Each entry specifies the functional
form of reading error as a function of true age. Possible entries include
the following:</p><dl><dt>-0-9+</dt>
<dd><p>Mirror the standard deviation of another reader, where the negative
integer corresponds to the column of the reader/lab that is being
mirrored minus one, e.g., <code>-1</code> causes it to mirror reader/lab 1, for
which data is stored in the second column of <code>Data</code>. This number must
be lower than -1 times the current position in the vector.</p></dd>

<dt>0</dt>
<dd><p>No error. But, there could be potential bias.</p></dd>

<dt>1</dt>
<dd><p>Constant coefficient of variation, i.e., a 1-parameter linear
relationship of the standard deviation with the true age.</p></dd>

<dt>2</dt>
<dd><p>Curvilinear standard deviation, i.e., a 3-parameter Hollings-form
relationship of standard deviation with true age.</p></dd>

<dt>3</dt>
<dd><p>Curvilinear coefficient of variation, i.e., a 3-parameter
Hollings-form relationship of coefficient of variation with true age.</p></dd>

<dt>5</dt>
<dd><p>Spline with estimated slope at beginning and end where the number of
parameters is 2 + number of knots.</p></dd>

<dt>6</dt>
<dd><p>Linear interpolation with a first knot of 1 and a last knot of the
maximum age, i.e., <code>MaxAge</code>.</p></dd>


</dl></dd>


<dt>KnotAges</dt>
<dd><p>Ages associated with each knot. This is a necessary input
for <code>SigOpt = 5</code> or <code>SigOpt = 6</code>.</p></dd>


<dt>BiasOpt</dt>
<dd><p>A vector with one entry for each reader/lab specifying the
type of bias specific to each reader. Positive values lead to estimated
parameters and negative values are used for shared parameters between
readers, just like with <code>SigOpt</code>. Parameter sharing is common when there
is more than one reader in a lab working together to refine their methods
such that they have matching techniques. Possible entries include the
following:</p><dl><dt>-0-9+</dt>
<dd><p>Mirror the bias of another reader, where the negative integer
corresponds to the column of the reader/lab that is being mirrored
minus one, e.g., <code>-1</code> causes it to mirror reader/lab 1, for which data
is stored in the second column of <code>Data</code>. This number must be lower
than -1 times the current position in the vector.</p></dd>

<dt>0</dt>
<dd><p>Unbiased, where at least one reader has to be unbiased.</p></dd>

<dt>1</dt>
<dd><p>Constant coefficient of variation, i.e., a 1-parameter linear
relationship of bias with true age.</p></dd>

<dt>2</dt>
<dd><p>Curvilinear, i.e., a 2-parameter Hollings-form relationship of bias
with true age.</p></dd>


</dl><p>An example entry for the situation where you have seven readers and you
assume that the first reader is unbiased, readers 2-7 have a curvilinear
bias, reader 3 shares parameters with reader 2, reader 5 shares parameters
with reader 4, and reader 7 shares parameters with reader 6 would look
like <code>c(0, 2, -2, 2, -4, 2, -6)</code>.</p></dd>


<dt>NDataSets</dt>
<dd><p>This is generally <code>1</code> and other values are not implemented.</p></dd>


<dt>MinAge</dt>
<dd><p>An integer, specifying the minimum possible "true" age.</p></dd>


<dt>MaxAge</dt>
<dd><p>An integer, specifying the maximum possible "true" age.</p></dd>


<dt>RefAge</dt>
<dd><p>An arbitrarily chosen age from which "true" age-composition
fixed-effects are calculated as an offset. This has no effect on the
answer but could potentially effect estimation speed.</p></dd>


<dt>MinusAge</dt>
<dd><p>The minimum age for which an age-specific age-composition is
estimated. Ages below <code>MinusAge</code> have "true" proportion-at-age
(\(P_{a}\)) estimated as
$$P_a = P_{MinusAge}*exp^{(\beta*(MinusAge - a))}$$,
where beta is an estimated log-linear trend in the "true"
proportion-at-age. If <code>MinusAge</code> = <code>MinAge</code>, beta is not estimated.</p></dd>


<dt>PlusAge</dt>
<dd><p>Identical to <code>MinusAge</code> except defining the age above with
age-specific age composition is not estimated.</p></dd>


<dt>MaxSd</dt>
<dd><p>An upper bound on possible values for the standard deviation
of reading error.</p></dd>


<dt>MaxExpectedAge</dt>
<dd><p>Set to MaxAge.</p></dd>


<dt>SaveFile</dt>
<dd><p>Directory where <code>agemat.exe</code> is located and where all ADMB
intermediate and output files should be located. If <code>AdmbFile</code> is specified
then <code>agemat.exe</code> is copied from that directory to <code>SaveFile</code>.</p></dd>


<dt>EffSampleSize</dt>
<dd><p>Indicating whether effective sample size should be
calculated. Missing values in the data matrix will cause this to be
ineffective, in which case this should be set to <code>0</code>.</p></dd>


<dt>Intern</dt>
<dd><p>A logical input that controls the amount of output displayed,
where <code>TRUE</code> indicates that ADMB output should be displayed in R and
<code>FALSE</code> leads to the suppression of this information.</p></dd>


<dt>AdmbFile</dt>
<dd><p>An optional character entry that specifies the directory
from which <code>agemat.exe</code> is to be copied from to <code>SaveFile</code>.</p></dd>


<dt>JustWrite</dt>
<dd><p>A logical input that allows just the data files to be
written without running ADMB executable.</p></dd>


<dt>CallType</dt>
<dd><p>Either <code>"system"</code> or <code>"shell"</code> depending on Operating System
or how R is being run. The default is <code>"system"</code>.</p></dd>


<dt>ExtraArgs</dt>
<dd><p>A string of characters providing extra arguments passed to
ADMB. The default is <code>" -est"</code>.</p></dd>


<dt>verbose</dt>
<dd><p>A logical input that controls the amount of feedback users
receive from the program. The default is to provide the most output as
possible with <code>verbose = TRUE</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The premise of Punt <em>et al.</em> (2008) is to calculate the likelihood
of model parameters given an observed data set of otolith age reads from
multiple age readers. For each reader/lab, two parameters are defined, one
for standard deviation and one for bias. The model calculates the expected
age of each read and the standard deviation of a normally distributed
reading error given the true age of an otolith. These relationships can be
linear or curvilinear.</p>
<p>The true age is obviously an unobserved process and can be considered a
random effect. Thus, the software computes the likelihood while summing
across all possible discrete values for the true age of each otolith. This
true age requires a hyperdistribution that represents the prior probability
that an otolith is any given age. The hyperdistribution is controlled by a
set of hyperparameters and the parameters that govern the standard deviation
and bias of each age reader/lab. Specifically, one hyperparameter is
estimated for every age between and including the <code>MinusAge</code> and <code>PlusAge</code>.
Ages outside of this range have a prior proportion at age defined as a
loglinear deviation from the proportion at age for the extreme ages, i.e.,
<code>MinusAge</code> and <code>PlusAge</code>. The slope of these loglinear deviations thus
constitutes an additional 1 or 2 fixed effect parameters. The true
proportion at age is then calculated from these fixed effects and loglinear
slope parameters by normalizing the resulting distribution such that it sums
to one.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><code><a href="StepwiseFn.html">StepwiseFn()</a></code> will run multiple models.</p></li>
<li><p><code><a href="PlotOutputFn.html">PlotOutputFn()</a></code> will help summarize the output.</p></li>
</ul></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>James T. Thorson, Ian J. Stewart, Andre E. Punt, Ian G. Taylor</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/example.html" class="external-link">example</a></span><span class="op">(</span><span class="va">SimulatorFn</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Parameters for generating data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # This represents 2 unique readers</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Row 1 -- Otoliths read only once by reader</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Row 2 -- Otoliths read twice by reader 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Row 2 -- Otoliths read only once by reader 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Row 4 -- Otoliths read twice by reader 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Row 5 -- Otoliths read once by reader 1 and once by reader 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; ReadsMat &lt;- structure(matrix(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   nrow = 5, ncol = 5,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   c(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     rep(25, 5),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     1, 1, 0, 0, 1,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     0, 1, 0, 0, 0,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     0, 0, 1, 1, 1,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     0, 0, 0, 1, 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+ ), dimnames = list(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   c(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader1_Only", "Reader1_DoubleReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader2_Only", "Reader2_DoubleReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader1_&amp;_Reader2"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   ),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   c(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "NumberOfReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader1", "Reader1_DoubleReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader2", "Reader2_DoubleReads"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+ ))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Generate data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; set.seed(2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; AgeReads &lt;- SimulatorFn(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   Nreaders = 4, M = 0.2,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   SelexForm = "Logistic",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   SelexParams = c(5, 0.2), BiasParams = c(1, 1, 1.1, 1.1),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   ErrorParams = c(0.2, 0.2, 0.2, 0.2), ReadsMat = ReadsMat,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   RecCv = 0.6, RecAr1 = 0.8, Amax = 100</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+ )</span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">AgeReads</span>,</span></span>
<span class="r-in"><span>  file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"Simulated_data_example.csv"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##### Format data</span></span></span>
<span class="r-in"><span><span class="va">Nreaders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">AgeReads</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Change NA to -999 (which the Punt software considers missing data)</span></span></span>
<span class="r-in"><span><span class="va">AgeReads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AgeReads</span><span class="op">)</span>, <span class="op">-</span><span class="fl">999</span>, <span class="va">AgeReads</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Potentially eliminate rows that are only read once</span></span></span>
<span class="r-in"><span><span class="co"># These rows have no information about reading error, but are potentially</span></span></span>
<span class="r-in"><span><span class="co"># informative about latent age-structure. It is unknown whether eliminating</span></span></span>
<span class="r-in"><span><span class="co"># these rows degrades estimation of error and bias, and is currently</span></span></span>
<span class="r-in"><span><span class="co"># recommended to speed up computation</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">KeepRow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">AgeReads</span> <span class="op">==</span> <span class="op">-</span><span class="fl">999</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>    <span class="cn">FALSE</span>, <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">AgeReads</span> <span class="op">&lt;-</span> <span class="va">AgeReads</span><span class="op">[</span><span class="va">KeepRow</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># AgeReads2 is the correctly formatted data object</span></span></span>
<span class="r-in"><span><span class="va">AgeReads2</span> <span class="op">&lt;-</span> <span class="fu"><a href="rMx.html">rMx</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">AgeReads</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Combine duplicate rows</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">RowI</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">AgeReads</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">DupRow</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></span>
<span class="r-in"><span>  <span class="kw">for</span> <span class="op">(</span><span class="va">PreviousRowJ</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">AgeReads2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>      <span class="va">AgeReads</span><span class="op">[</span><span class="va">RowI</span>, <span class="fl">1</span><span class="op">:</span><span class="va">Nreaders</span><span class="op">]</span> <span class="op">==</span> <span class="va">AgeReads2</span><span class="op">[</span><span class="va">PreviousRowJ</span>, <span class="fl">1</span><span class="op">:</span><span class="va">Nreaders</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span>    <span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">DupRow</span> <span class="op">&lt;-</span> <span class="va">PreviousRowJ</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DupRow</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Add new row to AgeReads2</span></span></span>
<span class="r-in"><span>    <span class="va">AgeReads2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">AgeReads2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">AgeReads</span><span class="op">[</span><span class="va">RowI</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">DupRow</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Increment number of samples for previous duplicate</span></span></span>
<span class="r-in"><span>    <span class="va">AgeReads2</span><span class="op">[</span><span class="va">DupRow</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">AgeReads2</span><span class="op">[</span><span class="va">DupRow</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">######## Determine settings for ADMB</span></span></span>
<span class="r-in"><span><span class="co"># Define minimum and maximum ages for integral across unobserved ages</span></span></span>
<span class="r-in"><span><span class="va">MinAge</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">MaxAge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">AgeReads2</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span></span></span>
<span class="r-in"><span><span class="va">BiasOpt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">SigOpt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Necessary for SigOpt option 5 or 6</span></span></span>
<span class="r-in"><span><span class="va">KnotAges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="va">MaxAge</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##### Run the model (MAY TAKE 5-10 MINUTES)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">fileloc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"age"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">fileloc</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">RunFn</span><span class="op">(</span></span></span>
<span class="r-in"><span>  Data <span class="op">=</span> <span class="va">AgeReads2</span>, SigOpt <span class="op">=</span> <span class="va">SigOpt</span>, KnotAges <span class="op">=</span> <span class="va">KnotAges</span>,</span></span>
<span class="r-in"><span>  BiasOpt <span class="op">=</span> <span class="va">BiasOpt</span>,</span></span>
<span class="r-in"><span>  NDataSets <span class="op">=</span> <span class="fl">1</span>, MinAge <span class="op">=</span> <span class="va">MinAge</span>, MaxAge <span class="op">=</span> <span class="va">MaxAge</span>, RefAge <span class="op">=</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  MinusAge <span class="op">=</span> <span class="fl">1</span>, PlusAge <span class="op">=</span> <span class="fl">30</span>, SaveFile <span class="op">=</span> <span class="va">fileloc</span>,</span></span>
<span class="r-in"><span>  AdmbFile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"executables"</span>,</span></span>
<span class="r-in"><span>    package <span class="op">=</span> <span class="st">"nwfscAgeingError"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">file.sep</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  EffSampleSize <span class="op">=</span> <span class="fl">0</span>, Intern <span class="op">=</span> <span class="cn">FALSE</span>, JustWrite <span class="op">=</span> <span class="cn">FALSE</span>, CallType <span class="op">=</span> <span class="st">"shell"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andre E. Punt, Kelli F. Johnson, Ian G. Taylor, Paul Burch.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

