<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Run step-wise model selection to facilitate the exploration of several
modelling configurations using Akaike information criterion (AIC)."><title>Step-wise model selection — StepwiseFn • AgeingError</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Step-wise model selection — StepwiseFn"><meta property="og:description" content="Run step-wise model selection to facilitate the exploration of several
modelling configurations using Akaike information criterion (AIC)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">AgeingError</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/getting_started.html">Estimating ageing error using the TMB model written by André Punt</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/pfmc-assessments/AgeingError/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Step-wise model selection</h1>
      <small class="dont-index">Source: <a href="https://github.com/pfmc-assessments/AgeingError/blob/HEAD/R/StepwiseFn.R" class="external-link"><code>R/StepwiseFn.R</code></a></small>
      <div class="d-none name"><code>StepwiseFn.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Run step-wise model selection to facilitate the exploration of several
modelling configurations using Akaike information criterion (AIC).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">StepwiseFn</span><span class="op">(</span></span>
<span>  <span class="va">SearchMat</span>,</span>
<span>  <span class="va">Data</span>,</span>
<span>  <span class="va">NDataSets</span>,</span>
<span>  <span class="va">KnotAges</span>,</span>
<span>  <span class="va">MinAge</span>,</span>
<span>  <span class="va">MaxAge</span>,</span>
<span>  <span class="va">RefAge</span>,</span>
<span>  <span class="va">MaxSd</span>,</span>
<span>  <span class="va">MaxExpectedAge</span>,</span>
<span>  <span class="va">SaveFile</span>,</span>
<span>  EffSampleSize <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  Intern <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  InformationCriterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AIC"</span>, <span class="st">"AICc"</span>, <span class="st">"BIC"</span><span class="op">)</span>,</span>
<span>  SelectAges <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>SearchMat</dt>
<dd><p>A matrix explaining stepwise model selection options. One
row for each readers error and one row for each readers bias + 2 rows, one
for <code>MinusAge</code>, i.e., the age where the proportion at age begins to
decrease exponentially with decreasing age, and one for <code>PlusAge</code>, i.e.,
the age where the proportion-at-age begins to decrease exponentially with
increasing age.</p>
<p>Each element of a given row is a possible value to search across for that
reader. So, the number of columns of <code>SearchMat</code> will be the maximum
number of options that you want to include. Think of it as several vectors
stacked row-wise where shorter rows are filled in with <code>NA</code> values. If
reader two only has two options that the analyst wants to search over the
remainder of the columns should be filled with <code>NA</code> values for that row.</p></dd>


<dt>Data</dt>
<dd><p>This is the data set with the first column being an integer
providing the number of otoliths that are included in the row and the
subsequent columns are the reader or lab estimated ag,e where each
reader/lab has a unique reading error and bias. The modeling framework
allows for, at most, 15 readers, i.e., 16 columns. There should not be any
identical rows in the data frame because otoliths that have the exact same
read from every reader/lab should be combined into a single row with the
count as the first column. If you failed to combine identical rows prior
to running the model, you will be alerted with an error and the <code>XXX.rep</code>
file will have a properly formatted data which can be' cut-pasted into a
<code>XXX.dat</code> file for use. Missing reads from a given reader/lab should be
entered as <code>-999</code>. Order your reader/lab columns such that similar
readers/labs are located next to one another because columns to the right
can mirror columns to their immediate left in terms of parameter
estimates.</p></dd>


<dt>NDataSets</dt>
<dd><p>This is generally <code>1</code> and other values are not implemented.</p></dd>


<dt>KnotAges</dt>
<dd><p>Ages associated with each knot. This is a necessary input
for <code>SigOpt = 5</code> or <code>SigOpt = 6</code>.</p></dd>


<dt>MinAge</dt>
<dd><p>An integer, specifying the minimum possible "true" age.</p></dd>


<dt>MaxAge</dt>
<dd><p>An integer, specifying the maximum possible "true" age.</p></dd>


<dt>RefAge</dt>
<dd><p>An arbitrarily chosen age from which "true" age-composition
fixed-effects are calculated as an offset. This has no effect on the
answer but could potentially effect estimation speed.</p></dd>


<dt>MaxSd</dt>
<dd><p>An upper bound on possible values for the standard deviation
of reading error.</p></dd>


<dt>MaxExpectedAge</dt>
<dd><p>Set to MaxAge.</p></dd>


<dt>SaveFile</dt>
<dd><p>Directory where <code>agemat.exe</code> is located and where all ADMB
intermediate and output files should be located. If <code>AdmbFile</code> is specified
then <code>agemat.exe</code> is copied from that directory to <code>SaveFile</code>.</p></dd>


<dt>EffSampleSize</dt>
<dd><p>Indicating whether effective sample size should be
calculated. Missing values in the data matrix will cause this to be
ineffective, in which case this should be set to <code>0</code>.</p></dd>


<dt>Intern</dt>
<dd><p>A logical input that controls the amount of output displayed,
where <code>TRUE</code> indicates that ADMB output should be displayed in R and
<code>FALSE</code> leads to the suppression of this information.</p></dd>


<dt>InformationCriterion</dt>
<dd><p>A string specifying the type of information
criterion that should be used to choose the best model. The default is to
use AIC, though AIC corrected for small sample sizes and BIC are also
available.</p></dd>


<dt>SelectAges</dt>
<dd><p>A logical input specifying if the boundaries should be
based on <code>MinusAge</code> and <code>PlusAge</code>. The default is <code>TRUE</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>AIC seems like an appropriate method to select among possible
values for <code>PlusAge</code>, i.e., the last row of <code>SearchMat</code>, because <code>PlusAge</code>
determines the number of estimated fixed-effect hyperparameters that are
used to define the true proportion-at-age hyperdistribution. This
hyperdistribution is in turn used as a prior when integrating across a true
age associated with each otolith. This true age, which is a latent effect,
can be interpreted as a random effect with one for each observation. So, the
use of AIC to select among parameterizations of the fixed effects defining
this hyperdistribution is customary (Pinheiro and Bates, 2009). This was
tested for sablefish, where AIC lead to a true proportion at age that was
biologically plausible.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Punt, A.E., Smith, D.C., KrusicGolub, K., and Robertson, S. 2008.
Quantifying age-reading error for use in fisheries stock assessments,
with application to species in Australia's southern and eastern scalefish
and shark fishery. Can. J. Fish. Aquat. Sci. 65: 1991-2005.</p>
<p>Pinheiro, J.C., and Bates, D. 2009. Mixed-Effects Models in S and S-PLUS.
Springer, Germany.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><code><a href="RunFn.html">RunFn()</a></code> will run a single model, where this function runs multiple models.</p></li>
<li><p><code><a href="PlotOutputFn.html">PlotOutputFn()</a></code> will help summarize the output from <code><a href="RunFn.html">RunFn()</a></code>.</p></li>
</ul></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>James T. Thorson</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/example.html" class="external-link">example</a></span><span class="op">(</span><span class="va">RunFn</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; example(SimulatorFn)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Parameters for generating data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # This represents 2 unique readers</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt;   # Row 1 -- Otoliths read only once by reader </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt;   # Row 2 -- Otoliths read twice by reader 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt;   # Row 2 -- Otoliths read only once by reader 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt;   # Row 4 -- Otoliths read twice by reader 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt;   # Row 5 -- Otoliths read once by reader 1 and once by reader 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; ReadsMat &lt;- structure(matrix(nrow = 5, ncol = 5,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   c(rep(25, 5),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     1, 1, 0, 0, 1,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     0, 1, 0, 0, 0,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     0, 0, 1, 1, 1,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     0, 0, 0, 1, 0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   ), dimnames = list(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     c("Reader1_Only", "Reader1_DoubleReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+       "Reader2_Only", "Reader2_DoubleReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+       "Reader1_&amp;_Reader2"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     ),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+    c("NumberOfReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader1", "Reader1_DoubleReads",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     "Reader2", "Reader2_DoubleReads"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+     ))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; # Generate data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; set.seed(2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF&gt; AgeReads &lt;- SimulatorFn(Nreaders = 4, M = 0.2,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   SelexForm = "Logistic",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   SelexParams = c(5, 0.2), BiasParams = c(1, 1, 1.1, 1.1),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   ErrorParams = c(0.2, 0.2, 0.2, 0.2), ReadsMat = ReadsMat,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SmltrF+   RecCv = 0.6, RecAr1 = 0.8, Amax = 100)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ## Not run: </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D utils::write.csv(AgeReads,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D   file = file.path(getwd(), "Simulated_data_example.csv"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ## End(Not run)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##### Format data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; Nreaders &lt;- ncol(AgeReads)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # Change NA to -999 (which the Punt software considers missing data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; AgeReads &lt;- ifelse(is.na(AgeReads), -999, AgeReads)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # Potentially eliminate rows that are only read once</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # These rows have no information about reading error, but are potentially</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # informative about latent age-structure. It is unknown whether eliminating</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # these rows degrades estimation of error and bias, and is currently</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # recommended to speed up computation</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; if (FALSE) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   KeepRow &lt;- ifelse(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     rowSums(ifelse(AgeReads == -999, 0, 1), na.rm = TRUE) &lt;= 1,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     FALSE, TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   AgeReads &lt;- AgeReads[KeepRow, ]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+ }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # AgeReads2 is the correctly formatted data object</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; AgeReads2 &lt;- rMx(c(1, AgeReads[1, ]))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # Combine duplicate rows</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; for (RowI in 2:nrow(AgeReads)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   DupRow &lt;- NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   for (PreviousRowJ in 1:nrow(AgeReads2)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     if (all(</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+       AgeReads[RowI,1:Nreaders] == AgeReads2[PreviousRowJ,1:Nreaders+1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     )) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+       DupRow &lt;- PreviousRowJ</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   if (is.na(DupRow)) {# Add new row to AgeReads2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     AgeReads2 &lt;- rbind(AgeReads2, c(1, AgeReads[RowI, ]))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   if(!is.na(DupRow)){# Increment number of samples for previous duplicate</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+     AgeReads2[DupRow,1] &lt;- AgeReads2[DupRow,1] + 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn+ }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ######## Determine settings for ADMB</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # Define minimum and maximum ages for integral across unobserved ages</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; MinAge &lt;- 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; MaxAge &lt;- ceiling(max(AgeReads2[,-1])/10)*10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; BiasOpt &lt;- c(0, -1, 0, -3)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; SigOpt &lt;- c(1, -1, 6, -3)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; # Necessary for SigOpt option 5 or 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; KnotAges &lt;- list(NA, NA, c(1, 10, 20, MaxAge), NA)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##### Run the model (MAY TAKE 5-10 MINUTES)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ## Not run: </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D fileloc &lt;- file.path(tempdir(), "age")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D dir.create(fileloc, showWarnings = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D RunFn(Data = AgeReads2, SigOpt = SigOpt, KnotAges = KnotAges,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D   BiasOpt = BiasOpt,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D   NDataSets = 1, MinAge = MinAge, MaxAge = MaxAge, RefAge = 10,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D   MinusAge = 1, PlusAge = 30, SaveFile = fileloc,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D   AdmbFile = file.path(system.file("executables",</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D     package = "nwfscAgeingError"), .Platform$file.sep),</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D   EffSampleSize = 0, Intern = FALSE, JustWrite = FALSE, CallType = "shell"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ##D )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; ## End(Not run)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> RunFn&gt; </span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">##### Run the model (MAY TAKE 5-10 MINUTES)</span></span></span>
<span class="r-in"><span><span class="va">fileloc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"age"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">fileloc</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="RunFn.html">RunFn</a></span><span class="op">(</span>Data <span class="op">=</span> <span class="va">AgeReads2</span>, SigOpt <span class="op">=</span> <span class="va">SigOpt</span>, KnotAges <span class="op">=</span> <span class="va">KnotAges</span>,</span></span>
<span class="r-in"><span>  BiasOpt <span class="op">=</span> <span class="va">BiasOpt</span>,</span></span>
<span class="r-in"><span>  NDataSets <span class="op">=</span> <span class="fl">1</span>, MinAge <span class="op">=</span> <span class="va">MinAge</span>, MaxAge <span class="op">=</span> <span class="va">MaxAge</span>, RefAge <span class="op">=</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  MinusAge <span class="op">=</span> <span class="fl">1</span>, PlusAge <span class="op">=</span> <span class="fl">30</span>, SaveFile <span class="op">=</span> <span class="va">fileloc</span>,</span></span>
<span class="r-in"><span>  AdmbFile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"executables"</span>,</span></span>
<span class="r-in"><span>    package <span class="op">=</span> <span class="st">"nwfscAgeingError"</span><span class="op">)</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">file.sep</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  EffSampleSize <span class="op">=</span> <span class="fl">0</span>, Intern <span class="op">=</span> <span class="cn">FALSE</span>, JustWrite <span class="op">=</span> <span class="cn">FALSE</span>, CallType <span class="op">=</span> <span class="st">"shell"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Plot output</span></span></span>
<span class="r-in"><span><span class="fu"><a href="PlotOutputFn.html">PlotOutputFn</a></span><span class="op">(</span>Data <span class="op">=</span> <span class="va">AgeReads2</span>, MaxAge <span class="op">=</span> <span class="va">MaxAge</span>,</span></span>
<span class="r-in"><span>  SaveFile <span class="op">=</span> <span class="va">fileloc</span>, PlotType <span class="op">=</span> <span class="st">"PDF"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##### Stepwise selection</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Parameters</span></span></span>
<span class="r-in"><span><span class="va">MaxAge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">AgeReads2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span></span></span>
<span class="r-in"><span><span class="va">MinAge</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##### Stepwise selection</span></span></span>
<span class="r-in"><span><span class="va">StartMinusAge</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">StartPlusAge</span> <span class="op">&lt;-</span> <span class="fl">30</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define matrix explaining stepwise model selection options</span></span></span>
<span class="r-in"><span><span class="co"># One row for each reader + 2 rows for</span></span></span>
<span class="r-in"><span><span class="co"># PlusAge (age where the proportion-at-age begins to</span></span></span>
<span class="r-in"><span><span class="co"># decrease exponentially with increasing age) and</span></span></span>
<span class="r-in"><span><span class="co"># MinusAge (the age where the proportion-at-age begins to</span></span></span>
<span class="r-in"><span><span class="co"># decrease exponentially with decreasing age)</span></span></span>
<span class="r-in"><span><span class="co"># Each element of a given row is a possible value to search</span></span></span>
<span class="r-in"><span><span class="co"># across for that reader</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>,</span></span>
<span class="r-in"><span>  dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Nreaders</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span>, <span class="fl">7</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Error_Reader"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">Nreaders</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Bias_Reader"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">Nreaders</span><span class="op">)</span>, <span class="st">"MinusAge"</span>, <span class="st">"PlusAge"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Option"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Readers 1 and 3 search across options 1-3 for ERROR</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/outer.html" class="external-link">%o%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Reader 2 mirrors reader 1</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span></span>
<span class="r-in"><span><span class="co"># Reader 4 mirrors reader 3</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">3</span></span></span>
<span class="r-in"><span><span class="co"># Reader 1 has no BIAS</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></span>
<span class="r-in"><span><span class="co"># Reader 2 mirrors reader 1</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span></span>
<span class="r-in"><span><span class="co"># Reader 3 search across options 0-2 for BIAS</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">7</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Reader 4 mirrors reader 3</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">8</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">3</span></span></span>
<span class="r-in"><span><span class="co"># MinusAge searches with a search kernal of -10,-4,-1,+0,+1,+4,+10</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span> <span class="op">-</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span> <span class="op">-</span> <span class="fl">4</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span> <span class="op">-</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span> <span class="op">+</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span> <span class="op">+</span> <span class="fl">4</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartMinusAge</span> <span class="op">+</span> <span class="fl">10</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">9</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">MinAge</span>,</span></span>
<span class="r-in"><span>  <span class="cn">NA</span>, <span class="va">SearchMat</span><span class="op">[</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># PlusAge searches with a search kernal of -10,-4,-1,+0,+1,+4,+10</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span> <span class="op">-</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span> <span class="op">-</span> <span class="fl">4</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span> <span class="op">-</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span> <span class="op">+</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span> <span class="op">+</span> <span class="fl">4</span>,</span></span>
<span class="r-in"><span>  <span class="va">StartPlusAge</span> <span class="op">+</span> <span class="fl">10</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">SearchMat</span><span class="op">[</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">MaxAge</span>,</span></span>
<span class="r-in"><span>  <span class="cn">NA</span>, <span class="va">SearchMat</span><span class="op">[</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run model selection</span></span></span>
<span class="r-in"><span><span class="co"># This outputs a series of files</span></span></span>
<span class="r-in"><span><span class="co"># 1. "Stepwise - Model loop X.txt" --</span></span></span>
<span class="r-in"><span><span class="co">#   Shows the AIC/BIC/AICc value for all different combinations</span></span></span>
<span class="r-in"><span><span class="co">#   of parameters arising from changing one parameter at a time</span></span></span>
<span class="r-in"><span><span class="co">#   according to SearchMat during loop X</span></span></span>
<span class="r-in"><span><span class="co"># 2. "Stepwise - Record.txt" --</span></span></span>
<span class="r-in"><span><span class="co">#   The Xth row of IcRecord shows the record of the</span></span></span>
<span class="r-in"><span><span class="co">#   Information Criterion for all trials in loop X,</span></span></span>
<span class="r-in"><span><span class="co">#   while the Xth row of StateRecord shows the current selected values</span></span></span>
<span class="r-in"><span><span class="co">#   for all parameters at the end of loop X</span></span></span>
<span class="r-in"><span><span class="co"># 3. Standard plots for each loop</span></span></span>
<span class="r-in"><span><span class="co"># WARNING: One run of this stepwise model building example can take</span></span></span>
<span class="r-in"><span><span class="co"># 8+ hours, and should be run overnight</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="fu">StepwiseFn</span><span class="op">(</span>SearchMat <span class="op">=</span> <span class="va">SearchMat</span>, Data <span class="op">=</span> <span class="va">AgeReads2</span>,</span></span>
<span class="r-in"><span>  NDataSets <span class="op">=</span> <span class="fl">1</span>, MinAge <span class="op">=</span> <span class="va">MinAge</span>, MaxAge <span class="op">=</span> <span class="va">MaxAge</span>,</span></span>
<span class="r-in"><span>  RefAge <span class="op">=</span> <span class="fl">10</span>, MaxSd <span class="op">=</span> <span class="fl">40</span>, MaxExpectedAge <span class="op">=</span> <span class="va">MaxAge</span> <span class="op">+</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>  SaveFile <span class="op">=</span> <span class="va">fileloc</span>, InformationCriterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AIC"</span>, <span class="st">"AICc"</span>, <span class="st">"BIC"</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andre E. Punt, Kelli F. Johnson, Ian G. Taylor, Paul Burch.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

